<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Comet — Final Building Walk</title>

<!-- iOS Specific Meta Tags -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Building Walk">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --white:#fff; --bg:#f8fafc; --ink:#0b1220;
    --blue:#2563eb; --blue2:#3b82f6; --muted:#6b7280;
    --card:#ffffff; --border:#e5e7eb; --shadow:rgba(0,0,0,.07);
    --section:#0f172a; --sectionText:#fff; --hint:#e2e8f0;
  }
  *{box-sizing:border-box}
  html{
    -webkit-overflow-scrolling:touch;
    -webkit-text-size-adjust:100%;
  }
  html,body{
    margin:0;
    padding:0;
    background:var(--bg);
    color:var(--ink);
    font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif;
  }
  body{
    padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
  }
  .wrap{
    max-width:1100px;
    margin:0 auto;
    padding:24px;
    padding-bottom:calc(24px + env(safe-area-inset-bottom));
  }
  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:8px 0 18px;
    border-bottom:1px solid var(--border);
    position:sticky;
    top:0;
    background:var(--bg);
    z-index:10;
  }
  .brand{display:flex;gap:12px;align-items:center}
  .brand svg{width:30px;height:30px}
  .brand h1{margin:0;font-size:1.35rem}
  .sub{color:var(--muted);font-weight:600}
  .bar{display:flex;gap:10px;flex-wrap:wrap}
  .btn{
    appearance:none;
    -webkit-appearance:none;
    border:1px solid transparent;
    background:var(--blue);
    color:#fff;
    padding:10px 14px;
    border-radius:10px;
    font-weight:700;
    cursor:pointer;
    font-size:16px;
    -webkit-tap-highlight-color:transparent;
    touch-action:manipulation;
    user-select:none;
    -webkit-user-select:none;
  }
  .btn:hover{background:var(--blue2)}
  .btn:active{transform:scale(0.96)}
  .ghost{background:transparent;border-color:var(--blue);color:var(--blue)}
  .ghost:hover{background:rgba(37,99,235,.08)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 8px 22px var(--shadow);margin-top:16px}

  label{font-weight:600;font-size:.95rem;color:#111827}
  input, textarea, select{
    width:100%;
    padding:12px 12px;
    font-size:16px;
    border:1px solid var(--border);
    border-radius:10px;
    background:#fff;
    -webkit-appearance:none;
    appearance:none;
  }
  textarea{min-height:68px;resize:vertical}
  .grid2{display:grid;gap:14px}
  @media(min-width:860px){.grid2{grid-template-columns:1.1fr 1fr 1fr}}

  .section{margin-top:18px;border:1px solid var(--border);border-radius:14px;overflow:hidden}
  .section .head{background:var(--section);color:var(--sectionText);padding:10px 14px;font-weight:800;display:flex;justify-content:space-between;align-items:center}
  .swipe-hint{display:none;color:#334155;background:var(--hint);padding:4px 10px;border-radius:999px;font-size:.75rem}

  .rows-wrap{overflow:auto;-webkit-overflow-scrolling:touch}
  .rows{display:grid;grid-template-columns:1.2fr 2fr .9fr .9fr .6fr;gap:0;border-top:1px solid var(--border);min-width:960px}
  .r{display:contents}
  .rows > div{border-top:1px solid var(--border)}
  .rows b{display:flex;align-items:center;padding:10px 12px;background:#f8fafc;border-right:1px solid var(--border);font-weight:700}
  .rows .cell{padding:0}
  .rows .cell textarea, .rows .cell input{border:none;border-radius:0;width:100%;padding:10px 10px;font-size:16px}
  .rows .th{background:#f1f5f9;font-weight:700}
  .rows .th div{padding:10px 12px;border-right:1px solid var(--border)}
  .rows .th div:last-child{border-right:none}

  body.exporting .no-export{display:none !important}

  footer{
    margin-top:20px;
    color:var(--muted);
    text-align:center;
    padding-bottom:env(safe-area-inset-bottom);
  }

  /* Mobile optimizations */
  @media(max-width:900px){
    .wrap{
      padding:16px;
      padding-bottom:calc(16px + env(safe-area-inset-bottom));
    }
    
    header{
      flex-direction:column;
      align-items:flex-start;
      gap:12px;
      padding:12px 0 16px;
      position:sticky;
      top:0;
      background:var(--bg);
      z-index:10;
      margin:0 -16px;
      padding-left:16px;
      padding-right:16px;
    }
    
    .brand{gap:10px}
    .brand svg{width:24px;height:24px}
    .brand h1{font-size:1.2rem}
    .sub{font-size:.9rem}
    
    .bar{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
      width:100%;
    }
    
    .btn{
      padding:12px 14px;
      min-height:48px;
      font-size:14px;
      width:100%;
    }
    
    .card{
      padding:16px;
      border-radius:14px;
    }
    
    .section{
      margin-left:-16px;
      margin-right:-16px;
      border-radius:0;
      border-left:none;
      border-right:none;
    }
    
    .rows-wrap{
      padding:0 16px;
    }
    
    .swipe-hint{display:inline-block}
  }

  @media(max-width:640px){
    .brand h1{font-size:1.1rem}
    .sub{font-size:.85rem}
    
    .grid2{
      grid-template-columns:1fr;
    }
    
    .rows{min-width:850px}
  }

  /* iPhone X and newer with notch */
  @supports(padding:max(0px)){
    body{
      padding-left:max(0px, env(safe-area-inset-left));
      padding-right:max(0px, env(safe-area-inset-right));
    }
  }

  /* Print */
  @media print{
    header .bar, .no-print{display:none !important}
    .card{box-shadow:none;border:1px solid #ddd;page-break-inside:avoid}
    body{background:#fff;padding:0 !important}
    a[href]:after{content:""}
    .rows-wrap{overflow:visible}
    .swipe-hint{display:none !important}
  }
</style>
</head>
<body>
<div class="wrap" id="content">
  <header>
    <div class="brand">
      <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 2l2.6 5.3L20 8l-4 3.9.9 5.6L12 15.8 7.1 17.5 8 11.9 4 8l5.4-.7L12 2z" fill="#2563eb"/></svg>
      <div>
        <h1>Comet Builders LLC</h1>
        <div class="sub">Final Building Walk</div>
      </div>
    </div>
    <div class="bar no-export">
      <a href="index.html" class="btn ghost">← Home</a>
      <button class="btn" onclick="window.print()">Print</button>
      <button class="btn ghost" onclick="downloadPDF()">PDF</button>
      <button class="btn ghost" onclick="saveState()">Save</button>
      <button class="btn ghost" onclick="loadState()">Load</button>
      <button class="btn ghost" onclick="clearState()">Clear</button>
    </div>
  </header>

  <section class="card">
    <div class="grid2">
      <div>
        <label>Project</label>
        <input id="proj" placeholder="Comet North Raleigh">
      </div>
      <div>
        <label>Building</label>
        <input id="bldg" placeholder="B01 / Address">
      </div>
      <div>
        <label>Unit # / Type</label>
        <input id="unit" placeholder="101 • 2BR">
      </div>
    </div>
    <div class="grid2" style="margin-top:12px">
      <div>
        <label>First Walk Date</label>
        <input id="first" type="date">
      </div>
      <div>
        <label>Acceptance Walk Date</label>
        <input id="accept" type="date">
      </div>
      <div>
        <label>Construction Rep</label>
        <input id="rep" placeholder="Name">
      </div>
    </div>
  </section>

  <div id="sections"></div>

  <footer>© <span id="yy"></span> Comet Builders LLC</footer>
</div>

<!-- PDF libs -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
  const KEY = 'punchlist_final_v3';
  document.getElementById('yy').textContent = new Date().getFullYear();
  document.getElementById('first').valueAsDate = new Date();

  const SECTIONS = [
    { title:'Mechanical Function',
      rows:['HVAC','Plumbing','Electrical','Telecommunications / Smart Panel','Wall Jacks']},
    { title:'Appliances', rows:['Refrigerator','Range','Microwave','Dishwasher','Disposal']},
    { title:'Front Door', rows:['General / Hardware']},
    { title:'Kitchen', rows:['Sink & Faucet','Cabinetry','Flooring','Walls','Other']},
    { title:'Living Room', rows:['Flooring','Walls','Other']},
    { title:'Patio', rows:['General']},
    { title:'Master Bedroom', rows:['Flooring','Closet / Doors','Other']},
    { title:'Master Bathroom', rows:['Sink & Faucet','Commode','Tub / Shower','Mirror','Flooring','Walls','Other']},
    { title:'Guest Bedroom', rows:['Flooring','Closet / Doors','Other']},
    { title:'Guest Bathroom', rows:['Sink & Faucet','Commode','Tub / Shower','Mirror','Flooring','Walls','Other']},
    { title:'Laundry Room', rows:['Water Heater','Flooring','Other']},
    { title:'General', rows:[
      'Interior Doors — Functioning Properly','Door Hardware — Functioning Properly',
      'Shelving — Complete','Mini Blinds — Complete','Cleaning — Satisfactory','Paint Touch-ups — Satisfactory'
    ]}
  ];

  const container = document.getElementById('sections');
  SECTIONS.forEach((sec, si)=>{
    const shell = document.createElement('section');
    shell.className = 'section card';
    shell.innerHTML = `
      <div class="head">
        <span>${sec.title}</span>
        <span class="swipe-hint">Swipe →</span>
      </div>
      <div class="rows-wrap">
        <div class="rows">
          <div class="th r">
            <div>Item</div>
            <div>Notes / Findings (wide)</div>
            <div>Resp. Party</div>
            <div>Completion Date</div>
            <div>Init.</div>
          </div>
        </div>
      </div>
    `;
    const rowsContainer = shell.querySelector('.rows');
    sec.rows.forEach((label, ri)=>{
      const r = document.createElement('div'); r.className = 'r';
      r.innerHTML = `
        <b>${label}</b>
        <div class="cell"><textarea data-k="${si}-${ri}-notes" placeholder="Describe issue, location, scope"></textarea></div>
        <div class="cell"><input data-k="${si}-${ri}-resp" placeholder="Trade / Vendor"></div>
        <div class="cell"><input data-k="${si}-${ri}-date" type="date"></div>
        <div class="cell"><input data-k="${si}-${ri}-init" placeholder="__"></div>
      `;
      rowsContainer.appendChild(r);
    });
    container.appendChild(shell);
  });

  function collect(){
    const meta = {
      proj: v('proj'), bldg: v('bldg'), unit: v('unit'),
      first: v('first'), accept: v('accept'), rep: v('rep')
    };
    const data = {};
    document.querySelectorAll('[data-k]').forEach(el=>data[el.dataset.k]=el.value);
    return {meta, data};
  }
  function applyState(st){
    if(!st) return;
    setv('proj', st.meta?.proj||''); setv('bldg', st.meta?.bldg||''); setv('unit', st.meta?.unit||'');
    setv('first', st.meta?.first||''); setv('accept', st.meta?.accept||''); setv('rep', st.meta?.rep||'');
    Object.entries(st.data||{}).forEach(([k,val])=>{
      const el = document.querySelector(`[data-k="${k}"]`); if(el) el.value = val;
    });
  }
  const v=id=>document.getElementById(id).value;
  const setv=(id,val)=>document.getElementById(id).value=val;

  function saveState(){ localStorage.setItem(KEY, JSON.stringify(collect())); alert('Saved!'); }
  function loadState(){
    const raw = localStorage.getItem(KEY);
    if(!raw){ alert('Nothing saved yet.'); return; }
    applyState(JSON.parse(raw));
  }
  function clearState(){
    if(!confirm('Clear this form?')) return;
    localStorage.removeItem(KEY);
    location.reload();
  }

  // auto-save
  setInterval(()=>localStorage.setItem(KEY, JSON.stringify(collect())), 1000);
  applyState(JSON.parse(localStorage.getItem(KEY) || 'null'));

  // Prevent double-tap zoom on iOS
  let lastTouchEnd = 0;
  document.addEventListener('touchend', function(event) {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
      event.preventDefault();
    }
    lastTouchEnd = now;
  }, false);

  /* PDF EXPORT */
  async function downloadPDF(){
    document.body.classList.add('exporting');
    await new Promise(r=>setTimeout(r, 50));

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({orientation:'p', unit:'pt', format:'letter'});
    const el = document.getElementById('content');

    const canvas = await html2canvas(el, {scale:2, useCORS:true, windowWidth: el.scrollWidth});
    const img = canvas.toDataURL('image/png');

    const pdfW = doc.internal.pageSize.getWidth();
    const pdfH = doc.internal.pageSize.getHeight();
    const imgW = pdfW;
    const imgH = canvas.height * (imgW / canvas.width);

    let heightLeft = imgH;
    let position = 0;

    doc.addImage(img, 'PNG', 0, position, imgW, imgH);
    heightLeft -= pdfH;

    while (heightLeft > 0) {
      position = -(imgH - heightLeft);
      doc.addPage();
      doc.addImage(img, 'PNG', 0, position, imgW, imgH);
      heightLeft -= pdfH;
    }

    const date = (v('accept') || v('first') || new Date().toISOString().slice(0,10));
    const proj = (v('proj') || 'Project').replace(/[^\w-]+/g,'_');
    const bldg = (v('bldg') || 'Bldg').replace(/[^\w-]+/g,'_');
    const unit = (v('unit') || 'Unit').replace(/[^\w-]+/g,'_');
    doc.save(`Final-Building-Walk—${proj}—${bldg}—${unit}—${date}.pdf`);

    document.body.classList.remove('exporting');
  }
</script>
</body>
</html>
