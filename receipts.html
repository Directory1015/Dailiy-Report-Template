<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Field Reporting Hub — Receipts</title>
  <meta name="description" content="Snap & send company receipts to accounting via EmailJS." />
  <!-- CSP: allow inline scripts so our JS runs -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    img-src 'self' data: blob:;
    style-src 'self' 'unsafe-inline';
    script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://www.gstatic.com;
    connect-src https://api.emailjs.com;
  ">
  <style>
    :root{
      --white:#ffffff; --bg:#f8fafc; --ink:#0f172a; --muted:#6b7280;
      --card:#ffffff; --border:#e5e7eb; --blue:#2563eb; --blue-ghost:rgba(37,99,235,.06);
      --accent:#22c55e; --red:#e11d48; --ring:rgba(37,99,235,.28);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:860px;margin:0 auto;padding:24px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    header a{color:var(--blue);text-decoration:none}
    header a:hover{text-decoration:underline}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--blue);background:var(--blue-ghost);color:var(--blue);padding:6px 10px;border-radius:999px;font-size:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.08);overflow:hidden}
    .card-head{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;gap:12px;align-items:center}
    .badge{font-size:12px;background:var(--blue);color:#fff;padding:4px 8px;border-radius:999px}
    .grid{display:grid;gap:16px;padding:18px}
    @media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
    label{display:block;font-size:14px;color:#0f172a;margin-bottom:6px}
    input,select,textarea,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;color:#0f172a;outline:none}
    input:focus,select:focus,textarea:focus{box-shadow:0 0 0 3px var(--ring);border-color:var(--blue)}
    textarea{resize:vertical;min-height:82px}
    .row{display:grid;gap:14px}
    .actions{display:flex;flex-wrap:wrap;gap:12px}
    .btn{cursor:pointer;border:none}
    .btn-primary{background:var(--blue);color:#fff;font-weight:700}
    .btn-ghost{background:transparent;border:1px solid var(--blue);color:var(--blue)}
    .btn-danger{background:linear-gradient(180deg,#fb7185,#e11d48);color:#fff;font-weight:700}
    .hint{font-size:12px;color:var(--muted)}
    .preview{display:flex;align-items:center;justify-content:center;background:#fff;border:1px dashed var(--border);border-radius:12px;min-height:260px;position:relative;overflow:hidden}
    .preview canvas{max-width:100%;height:auto;display:block}
    .tag{display:inline-flex;gap:6px;align-items:center;color:#0f172a;background:#eef2ff;border:1px solid #c7d2fe;padding:6px 10px;border-radius:999px;font-size:12px}
    .success{border-left:4px solid var(--accent);background:#ecfdf5;padding:10px 12px;border-radius:8px;color:#064e3b}
    .error{border-left:4px solid var(--red);background:#fff1f2;padding:10px 12px;border-radius:8px;color:#9f1239}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <a href="./">← Back to Hub</a>
      <span class="pill">Receipts Uploader (EmailJS)</span>
    </header>

    <div class="card">
      <div class="card-head">
        <span class="badge">New</span>
        <div>
          <div style="font-weight:700">Send a Receipt</div>
          <div class="hint">Snaps/Uploads, adaptive compression (EmailJS ~50KB variable limit). Photo is attached to the email.</div>
        </div>
      </div>

      <form id="receiptForm" class="grid" autocomplete="on">
        <!-- LEFT COLUMN -->
        <div class="row">
          <div style="display:flex;gap:12px;align-items:center">
            <label for="sendTo" style="margin:0">Send To</label>
            <select id="sendTo" name="sendTo" style="max-width:260px">
              <option value="accounting" selected>Accounting (accts@cometdev.com)</option>
              <option value="me">Me (test)</option>
            </select>
          </div>

          <div id="testEmailWrap">
            <label for="testEmail">Your Email (for Me/test)</label>
            <input id="testEmail" type="email" placeholder="you@cometdev.com" />
            <div class="hint">Used only when “Me (test)” is selected.</div>
          </div>

          <div>
            <label for="date">Date</label>
            <input id="date" name="date" type="date" required />
          </div>

          <!-- Name dropdown -->
          <div>
            <label for="name">Your Name</label>
            <select id="name" name="name" required>
              <option value="" disabled selected>Select your name</option>
              <option>David Gonzalez</option>
              <option>Jason Moran</option>
              <option>Seth Coker</option>
              <option>Trefyn Carter</option>
              <option>Ramiro Tristian Zavala</option>
              <option>Rolando Garcia</option>
              <option>Douglas Wheeler</option>
              <option>Nathan Isner</option>
            </select>
          </div>

          <!-- Project dropdown -->
          <div>
            <label for="project">Project</label>
            <select id="project" name="project" required>
              <option value="" disabled selected>Select a project</option>
              <option>Comet Pittsboro</option>
              <option>Comet Richlands</option>
              <option>Comet North Raleigh</option>
              <option>Comet Lake Jeanette</option>
            </select>
          </div>

          <!-- Building dropdown -->
          <div>
            <label for="building">Building #</label>
            <select id="building" name="building" required>
              <option value="" disabled selected>Select a building/area</option>
              <optgroup label="Buildings B">
                <option>B01</option><option>B02</option><option>B03</option><option>B04</option>
                <option>B05</option><option>B06</option><option>B07</option><option>B08</option>
              </optgroup>
              <optgroup label="Buildings C">
                <option>C01</option>
              </optgroup>
              <optgroup label="Buildings G">
                <option>G01</option><option>G02</option><option>G03</option><option>G04</option><option>G05</option>
                <option>G06</option><option>G07</option><option>G08</option><option>G09</option><option>G10</option>
              </optgroup>
              <optgroup label="Site Features">
                <option>Sign Monument</option>
                <option>Compactor</option>
                <option>Pool</option>
                <option>Pickleball Court</option>
              </optgroup>
            </select>
          </div>

          <div>
            <label for="vendor">Vendor</label>
            <input id="vendor" name="vendor" type="text" placeholder="Home Depot, CPS, Lowe’s…" required />
          </div>
          <div>
            <label for="amount">Amount (USD)</label>
            <input id="amount" name="amount" type="number" step="0.01" min="0" placeholder="0.00" required />
          </div>
          <div style="grid-column:1/-1">
            <label for="reason">Reason (optional)</label>
            <input id="reason" name="reason" type="text" placeholder="Brief purpose (e.g., 2” PVC fittings for B04 trench)" />
          </div>
          <div style="grid-column:1/-1">
            <label for="notes">Notes (optional)</label>
            <textarea id="notes" name="notes" placeholder="Extra context if needed"></textarea>
          </div>
        </div>

        <!-- RIGHT COLUMN -->
        <div class="row">
          <div>
            <label for="photo">Receipt Photo</label>
            <input id="photo" name="photo" type="file" accept="image/*" capture="environment" required />
            <div class="hint">Tip: On mobile this opens the camera.</div>
          </div>

          <div>
            <label for="quality">Compression</label>
            <select id="quality" name="quality">
              <option value="0.82">Default (balanced)</option>
              <option value="0.94">High quality (larger file)</option>
              <option value="0.6">Smaller file</option>
              <option value="original">No compression (try to keep quality)</option>
            </select>
            <div class="hint">We auto-fit under EmailJS’s ~50KB variable limit.</div>
          </div>

          <div style="grid-column:1/-1">
            <div class="preview" id="preview"><span class="hint">Preview appears here after you choose a photo.</span></div>
          </div>

          <div style="grid-column:1/-1">
            <div class="actions">
              <button type="submit" class="btn btn-primary" id="sendBtn">Send</button>
              <button type="button" class="btn btn-ghost" id="downloadBtn">Download JPEG</button>
              <button type="button" class="btn btn-danger" id="clearBtn">Clear</button>
            </div>
            <div id="statusArea"></div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    // ====== EMAILJS CONFIG ======
    const EMAILJS_PUBLIC_KEY = "IIVCOWFFago4wLIVZ";
    const EMAILJS_SERVICE_ID = "service_pgc6dhc";
    const EMAILJS_TEMPLATE_ID = "template_vucteoe";
    // ============================
    emailjs.init({ publicKey: EMAILJS_PUBLIC_KEY });

    const form = document.getElementById('receiptForm');
    const dateEl = document.getElementById('date');
    const photoEl = document.getElementById('photo');
    const preview = document.getElementById('preview');
    const statusArea = document.getElementById('statusArea');
    const downloadBtn = document.getElementById('downloadBtn');
    const clearBtn = document.getElementById('clearBtn');
    const sendBtn = document.getElementById('sendBtn');
    const qualitySel = document.getElementById('quality');
    const sendToSel = document.getElementById('sendTo');
    const testEmail = document.getElementById('testEmail');

    dateEl.valueAsDate = new Date();

    function showStatus(html, cls){ statusArea.innerHTML = `<div class="${cls||'hint'}">${html}</div>`; }
    function clearStatus(){ statusArea.innerHTML = ""; }

    let currentCanvas = null;
    let currentBlob = null;
    let originalFile = null;

    function canvasFromImage(file, maxSide=1600, quality=0.82){
      return new Promise((resolve,reject)=>{
        if(!file) return reject(new Error("No file"));
        const img = new Image();
        img.onload = () => {
          const { width, height } = img;
          const scale = Math.min(1, maxSide / Math.max(width, height));
          const w = Math.round(width * scale);
          const h = Math.round(height * scale);
          const can = document.createElement('canvas');
          can.width = w; can.height = h;
          const ctx = can.getContext('2d');
          ctx.drawImage(img, 0, 0, w, h);
          can.toBlob(b=>{
            if(!b) return reject(new Error("Blob failed"));
            resolve({ canvas: can, blob: b });
          }, 'image/jpeg', quality);
        };
        img.onerror = reject;
        const fr = new FileReader();
        fr.onload = ()=> img.src = fr.result;
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    function renderPreview(canvas){
      preview.innerHTML = "";
      preview.appendChild(canvas);
      currentCanvas = canvas;
    }

    function blobToBase64(blob){
      return new Promise((resolve,reject)=>{
        const fr = new FileReader();
        fr.onload = ()=> {
          const dataUrl = fr.result;
          resolve(String(dataUrl).split(',')[1]); // base64 only
        };
        fr.onerror = reject;
        fr.readAsDataURL(blob);
      });
    }

    // Adaptive compression to fit under EmailJS variable cap
    async function compressToLimit(fileOrBlob, opts = {}){
      const LIMIT = opts.limitBytes ?? 34000;       // CHANGED: target ≤ 34KB binary
      let maxSide = opts.startMaxSide ?? 1200;
      let quality = opts.startQuality ?? 0.78;
      const minSide = 600;
      const minQuality = 0.5;
      let candidate = fileOrBlob;

      for(let i=0;i<10;i++){
        const { blob } = await canvasFromImage(candidate, maxSide, quality);
        if (blob.size <= LIMIT) return { blob, maxSide, quality };
        if (quality > minQuality) {
          quality = Math.max(minQuality, quality - 0.08);
        } else if (maxSide > minSide) {
          maxSide = Math.max(minSide, Math.round(maxSide * 0.85));
        } else {
          return { blob, maxSide, quality, overLimit: true };
        }
        candidate = blob;
      }
      return { blob: candidate, maxSide, quality, overLimit: true };
    }

    photoEl.addEventListener('change', async ()=>{
      clearStatus();
      const f = photoEl.files?.[0];
      if(!f) return;
      originalFile = f;
      showStatus("Processing image…", "hint");
      try{
        // Always show a preview (scaled); we’ll compress separately for sending
        const { canvas } = await canvasFromImage(f, 900, 0.82);
        renderPreview(canvas);
        // Precompute a decent default blob for Download button
        const { blob } = await canvasFromImage(f, 1200, 0.82);
        currentBlob = blob;
        showStatus(`Preview ready.`, "tag");
      }catch(e){
        console.error(e);
        showStatus("Could not process image.", "error");
      }
    });

    clearBtn.addEventListener('click', ()=>{
      photoEl.value = "";
      preview.innerHTML = '<span class="hint">Preview appears here after you choose a photo.</span>';
      currentCanvas = null; currentBlob = null; originalFile = null; clearStatus();
    });

    // Robust download (canvas -> blob -> original)
    downloadBtn.addEventListener('click', async ()=>{
      try{
        if(currentCanvas){
          currentCanvas.toBlob(b=>{
            if(!b){ showStatus("Could not create image blob.", "error"); return; }
            const a = document.createElement('a');
            a.href = URL.createObjectURL(b);
            a.download = `receipt-${Date.now()}.jpg`;
            a.click();
            URL.revokeObjectURL(a.href);
          }, 'image/jpeg', 0.92);
          return;
        }
        const blob = currentBlob || originalFile;
        if(!blob){ showStatus("No image to download yet.", "error"); return; }
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `receipt-${Date.now()}.jpg`;
        a.click();
        URL.revokeObjectURL(a.href);
      }catch(e){
        console.error(e);
        showStatus("Download failed.", "error");
      }
    });

    // Show test email field only when needed (nice-to-have)
    sendToSel.addEventListener('change', ()=>{
      document.getElementById('testEmailWrap').style.display =
        sendToSel.value === 'me' ? 'block' : 'block'; // keep visible but message clarifies usage
    });

    async function handleSubmit(e){
      e.preventDefault();
      clearStatus();
      if(!photoEl.files?.[0]){ showStatus("Please select or take a photo.", "error"); return; }

      const isMe = sendToSel.value === 'me';
      if(isMe && !testEmail.value){ showStatus("Enter your email for test mode.", "error"); testEmail.focus(); return; }

      sendBtn.disabled = true;
      showStatus("Optimizing image…", "hint");

      try{
        const date = dateEl.value || new Date().toISOString().slice(0,10);
        const name = document.getElementById('name').value.trim();
        const project = document.getElementById('project').value.trim();
        const building = document.getElementById('building').value.trim();
        const vendor = document.getElementById('vendor').value.trim();
        const amount = document.getElementById('amount').value.trim();
        const reason = document.getElementById('reason').value.trim();
        const notes = document.getElementById('notes').value.trim();

        // Initial compression preferences (user choice influences starting point)
        let startQuality = 0.82, startMaxSide = 1200;
        if (qualitySel.value === '0.94') { startQuality = 0.9; startMaxSide = 1400; }
        if (qualitySel.value === '0.6')  { startQuality = 0.7; startMaxSide = 1000; }
        if (qualitySel.value === 'original') { startQuality = 0.85; startMaxSide = 1400; }

        // Compress to fit EmailJS payload limit
        const { blob: sendBlob, maxSide, quality, overLimit } =
          await compressToLimit(photoEl.files[0], { startQuality, startMaxSide, limitBytes: 34000 }); // CHANGED

        const base64 = await blobToBase64(sendBlob);

        // CHANGED: include data URL prefix for EmailJS attachment
        const attachmentDataUrl = `data:image/jpeg;base64,${base64}`;

        const filenameSafeVendor = vendor || 'vendor';
        const filename = `receipt_${date}_${filenameSafeVendor.replace(/\s+/g,'-')}_${amount.replace(/[^0-9.]/g,'')}.jpg`;

        // Show both binary size and estimated base64 size for transparency
        const b64Size = Math.ceil((sendBlob.size * 4) / 3); // rough estimate
        const kb = (n)=> (n/1024).toFixed(0);
        if (overLimit) {
          showStatus(`Heads up: minimized to ~${kb(sendBlob.size)} KB (≈${kb(b64Size)} KB base64). Max side ${maxSide}px @ q=${quality}.`, "hint");
        } else {
          showStatus(`Image optimized: ~${kb(sendBlob.size)} KB (≈${kb(b64Size)} KB base64). Sending…`, "hint");
        }

        const to_email = isMe ? testEmail.value.trim() : 'accts@cometdev.com';
        const cc_email = '';

        const templateParams = {
          to_email,
          cc_email,
          subject: `Receipt — ${project} ${building ? '('+building+') ' : ''}— ${vendor} — $${amount} — ${date}`,
          date, name, project, building, vendor, amount, reason, notes,
          // CHANGED: pass as EmailJS attachment (data URL)
          attachments: [{ name: filename, data: attachmentDataUrl, contentType: 'image/jpeg' }]
        };

        await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
        showStatus("✅ Sent. Check your inbox!", "success");
        form.reset(); dateEl.valueAsDate = new Date();
        preview.innerHTML = '<span class="hint">Preview appears here after you choose a photo.</span>';
        currentCanvas = null; currentBlob = null; originalFile = null;
      }catch(err){
        console.error(err);
        showStatus(`Couldn’t send. ${err?.text || err?.message || 'Check EmailJS logs for details.'}`, "error");
      }finally{
        sendBtn.disabled = false;
      }
    }

    form.addEventListener('submit', handleSubmit);
  </script>
</body>
</html>


