<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Field Reporting Hub — Receipts</title>
  <meta name="description" content="Snap & send company receipts to accounting via EmailJS." />
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    img-src 'self' data: blob:;
    style-src 'self' 'unsafe-inline';
    script-src 'self' https://cdn.jsdelivr.net https://www.gstatic.com;
    connect-src https://api.emailjs.com;
  ">
  <style>
    :root{
      --white:#ffffff; --bg:#f8fafc; --ink:#0f172a; --muted:#6b7280;
      --card:#ffffff; --border:#e5e7eb; --blue:#2563eb; --blue-ghost:rgba(37,99,235,.06);
      --accent:#22c55e; --red:#e11d48; --ring:rgba(37,99,235,.28);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:860px;margin:0 auto;padding:24px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    header a{color:var(--blue);text-decoration:none}
    header a:hover{text-decoration:underline}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--blue);background:var(--blue-ghost);color:var(--blue);padding:6px 10px;border-radius:999px;font-size:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.08);overflow:hidden}
    .card-head{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;gap:12px;align-items:center}
    .badge{font-size:12px;background:var(--blue);color:#fff;padding:4px 8px;border-radius:999px}
    .grid{display:grid;gap:16px;padding:18px}
    @media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
    label{display:block;font-size:14px;color:#0f172a;margin-bottom:6px}
    input,select,textarea,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;color:#0f172a;outline:none}
    input:focus,select:focus,textarea:focus{box-shadow:0 0 0 3px var(--ring);border-color:var(--blue)}
    textarea{resize:vertical;min-height:82px}
    .row{display:grid;gap:14px}
    .actions{display:flex;flex-wrap:wrap;gap:12px}
    .btn{cursor:pointer;border:none}
    .btn-primary{background:var(--blue);color:#fff;font-weight:700}
    .btn-ghost{background:transparent;border:1px solid var(--blue);color:var(--blue)}
    .btn-danger{background:linear-gradient(180deg,#fb7185,#e11d48);color:#fff;font-weight:700}
    .hint{font-size:12px;color:var(--muted)}
    .preview{display:flex;align-items:center;justify-content:center;background:#fff;border:1px dashed var(--border);border-radius:12px;min-height:260px;position:relative;overflow:hidden}
    .preview canvas{max-width:100%;height:auto;display:block}
    .tag{display:inline-flex;gap:6px;align-items:center;color:#0f172a;background:#eef2ff;border:1px solid #c7d2fe;padding:6px 10px;border-radius:999px;font-size:12px}
    .success{border-left:4px solid var(--accent);background:#ecfdf5;padding:10px 12px;border-radius:8px;color:#064e3b}
    .error{border-left:4px solid var(--red);background:#fff1f2;padding:10px 12px;border-radius:8px;color:#9f1239}
    .inline{display:flex;gap:10px;align-items:center}
    .disabled-wrap{opacity:.6}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <a href="./">← Back to Hub</a>
      <span class="pill">Receipts Uploader (EmailJS)</span>
    </header>

    <div class="card">
      <div class="card-head">
        <span class="badge">New</span>
        <div>
          <div style="font-weight:700">Send a Receipt</div>
          <div class="hint">Snaps/Uploads, optional compression. Sends via EmailJS with photo attached.</div>
        </div>
      </div>

      <form id="receiptForm" class="grid" autocomplete="on">
        <!-- Left column -->
        <div class="row">
          <div class="inline" style="gap:12px">
            <label for="sendTo" style="margin:0">Send To</label>
            <select id="sendTo" name="sendTo" style="max-width:260px">
              <option value="accounting" selected>Accounting (accts@cometdev.com)</option>
              <option value="me">Me (test)</option>
            </select>
          </div>

          <!-- Always visible; disabled unless 'Me (test)' -->
          <div id="testEmailWrap">
            <label for="testEmail">Your Email (for Me/test)</label>
            <input id="testEmail" type="email" placeholder="you@cometdev.com" disabled />
            <div class="hint">Enabled when “Me (test)” is selected.</div>
          </div>

          <div>
            <label for="date">Date</label>
            <input id="date" name="date" type="date" required />
          </div>
          <div>
            <label for="name">Your Name</label>
            <input id="name" name="name" type="text" placeholder="First Last" required />
          </div>
          <div>
            <label for="project">Project</label>
            <input id="project" name="project" type="text" placeholder="Comet Sneads Ferry / Pittsboro / …" required />
          </div>
          <div>
            <label for="building">Building #</label>
            <input id="building" name="building" type="text" placeholder="e.g., B01, B04, Clubhouse" required />
          </div>
          <div>
            <label for="vendor">Vendor</label>
            <input id="vendor" name="vendor" type="text" placeholder="Home Depot, CPS, Lowe’s…" required />
          </div>
          <div>
            <label for="amount">Amount (USD)</label>
            <input id="amount" name="amount" type="number" step="0.01" min="0" placeholder="0.00" required />
          </div>
          <div style="grid-column:1/-1">
            <label for="reason">Reason (optional)</label>
            <input id="reason" name="reason" type="text" placeholder="Brief purpose (e.g., 2” PVC fittings for B04 trench)" />
          </div>
          <div style="grid-column:1/-1">
            <label for="notes">Notes (optional)</label>
            <textarea id="notes" name="notes" placeholder="Extra context if needed"></textarea>
          </div>
        </div>

        <!-- Right column -->
        <div class="row">
          <div>
            <label for="photo">Receipt Photo</label>
            <input id="photo" name="photo" type="file" accept="image/*" capture="environment" required />
            <div class="hint">Tip: On mobile this opens the camera.</div>
          </div>

          <div>
            <label for="quality">Compression</label>
            <select id="quality" name="quality">
              <option value="0.82">Default (balanced)</option>
              <option value="0.94">High quality (larger file)</option>
              <option value="0.6">Smaller file</option>
              <option value="original">No compression (send original)</option>
            </select>
            <div class="hint">We limit max side to 1600px by default.</div>
          </div>

          <div style="grid-column:1/-1">
            <div class="preview" id="preview"><span class="hint">Preview appears here after you choose a photo.</span></div>
          </div>

          <div style="grid-column:1/-1">
            <div class="actions">
              <button type="submit" class="btn btn-primary" id="sendBtn">Send</button>
              <button type="button" class="btn btn-ghost" id="downloadBtn">Download JPEG</button>
              <button type="button" class="btn btn-danger" id="clearBtn">Clear</button>
            </div>
            <div id="statusArea"></div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    // ====== EMAILJS CONFIG ======
    const EMAILJS_PUBLIC_KEY = "IIVCOWFFago4wLIVZ";
    const EMAILJS_SERVICE_ID = "service_pgc6dhc";
    const EMAILJS_TEMPLATE_ID = "template_vucteoe";
    // ============================
    emailjs.init({ publicKey: EMAILJS_PUBLIC_KEY });

    const form = document.getElementById('receiptForm');
    const dateEl = document.getElementById('date');
    const photoEl = document.getElementById('photo');
    const preview = document.getElementById('preview');
    const statusArea = document.getElementById('statusArea');
    const downloadBtn = document.getElementById('downloadBtn');
    const clearBtn = document.getElementById('clearBtn');
    const sendBtn = document.getElementById('sendBtn');
    const qualitySel = document.getElementById('quality');
    const sendToSel = document.getElementById('sendTo');
    const testEmail = document.getElementById('testEmail');
    const testEmailWrap = document.getElementById('testEmailWrap');

    dateEl.valueAsDate = new Date();

    function showStatus(html, cls){ statusArea.innerHTML = `<div class="${cls||'hint'}">${html}</div>`; }
    function clearStatus(){ statusArea.innerHTML = ""; }

    // Enable/disable the test email field
    function syncSendTo(){
      const isMe = sendToSel.value === 'me';
      testEmail.disabled = !isMe;
      testEmailWrap.classList.toggle('disabled-wrap', !isMe);
      if(isMe && !testEmail.value){
        testEmail.value = 'dgonzalez@cometdev.com'; // prefill for speed
      }
      if(isMe) testEmail.focus();
    }
    sendToSel.addEventListener('change', syncSendTo);
    syncSendTo(); // initialize on load

    let currentCanvas = null;
    let currentBlob = null;
    let originalFile = null;

    function canvasFromImage(file, maxSide=1600, quality=0.82){
      return new Promise((resolve,reject)=>{
        if(!file) return reject(new Error("No file"));
        const img = new Image();
        img.onload = () => {
          const { width, height } = img;
          const scale = Math.min(1, maxSide / Math.max(width, height));
          const w = Math.round(width * scale);
          const h = Math.round(height * scale);
          const can = document.createElement('canvas');
          can.width = w; can.height = h;
          const ctx = can.getContext('2d');
          ctx.drawImage(img, 0, 0, w, h);
          can.toBlob(b=>{
            if(!b) return reject(new Error("Blob failed"));
            resolve({ canvas: can, blob: b });
          }, 'image/jpeg', quality);
        };
        img.onerror = reject;
        const fr = new FileReader();
        fr.onload = ()=> img.src = fr.result;
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    function renderPreview(canvas){
      preview.innerHTML = "";
      preview.appendChild(canvas);
      currentCanvas = canvas;
    }

    function blobToBase64(blob){
      return new Promise((resolve,reject)=>{
        const fr = new FileReader();
        fr.onload = ()=> {
          const dataUrl = fr.result;
          resolve(String(dataUrl).split(',')[1]); // base64 only
        };
        fr.onerror = reject;
        fr.readAsDataURL(blob);
      });
    }

    photoEl.addEventListener('change', async ()=>{
      clearStatus();
      const f = photoEl.files?.[0];
      if(!f) return;
      originalFile = f;
      showStatus("Processing image…", "hint");
      try{
        if(qualitySel.value === 'original'){
          const { canvas } = await canvasFromImage(f, 1600, 0.9); // preview only
          renderPreview(canvas);
          currentBlob = f; // send original
          showStatus(`Ready (original selected)`, "tag");
        } else {
          const q = parseFloat(qualitySel.value);
          const { canvas, blob } = await canvasFromImage(f, 1600, isNaN(q)?0.82:q);
          renderPreview(canvas);
          currentBlob = blob;
          showStatus(`Ready to send (~${(blob.size/1024).toFixed(0)} KB)`, "tag");
        }
      }catch(e){
        console.error(e);
        showStatus("Could not process image.", "error");
      }
    });

    clearBtn.addEventListener('click', ()=>{
      photoEl.value = "";
      preview.innerHTML = '<span class="hint">Preview appears here after you choose a photo.</span>';
      currentCanvas = null; currentBlob = null; originalFile = null; clearStatus();
    });

    // Robust download (canvas -> blob -> original)
    downloadBtn.addEventListener('click', async ()=>{
      try{
        if(currentCanvas){
          currentCanvas.toBlob(b=>{
            if(!b){ showStatus("Could not create image blob.", "error"); return; }
            const a = document.createElement('a');
            a.href = URL.createObjectURL(b);
            a.download = `receipt-${Date.now()}.jpg`;
            a.click();
            URL.revokeObjectURL(a.href);
          }, 'image/jpeg', 0.92);
          return;
        }
        const blob = currentBlob || originalFile;
        if(!blob){ showStatus("No image to download yet.", "error"); return; }
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `receipt-${Date.now()}.jpg`;
        a.click();
        URL.revokeObjectURL(a.href);
      }catch(e){
        console.error(e);
        showStatus("Download failed.", "error");
      }
    });

    async function handleSubmit(e){
      e.preventDefault();
      clearStatus();
      if(!photoEl.files?.[0]){ showStatus("Please select or take a photo.", "error"); return; }

      const isMe = sendToSel.value === 'me';
      if(isMe && !testEmail.value){ showStatus("Enter your email for test mode.", "error"); testEmail.focus(); return; }

      sendBtn.disabled = true;
      showStatus("Sending via EmailJS…", "hint");

      try{
        const date = dateEl.value || new Date().toISOString().slice(0,10);
        const name = document.getElementById('name').value.trim();
        const project = document.getElementById('project').value.trim();
        const building = document.getElementById('building').value.trim();
        const vendor = document.getElementById('vendor').value.trim();
        const amount = document.getElementById('amount').value.trim();
        const reason = document.getElementById('reason').value.trim();
        const notes = document.getElementById('notes').value.trim();

        let blobToSend = currentBlob;
        if(!blobToSend){
          const q = qualitySel.value === 'original' ? 0.92 : parseFloat(qualitySel.value||'0.82');
          const { blob } = await canvasFromImage(photoEl.files[0], 1600, q);
          blobToSend = (qualitySel.value === 'original') ? photoEl.files[0] : blob;
        }

        const base64 = await blobToBase64(blobToSend);
        const filenameSafeVendor = vendor || 'vendor';
        const filename = `receipt_${date}_${filenameSafeVendor.replace(/\s+/g,'-')}_${amount.replace(/[^0-9.]/g,'')}.jpg`;

        const to_email = isMe ? testEmail.value.trim() : 'accts@cometdev.com';
        const cc_email = ''; // set to your address if you want a copy every time

        const templateParams = {
          to_email,
          cc_email,
          subject: `Receipt — ${project} ${building ? '('+building+') ' : ''}— ${vendor} — $${amount} — ${date}`,
          date, name, project, building, vendor, amount, reason, notes,
          attachments: [{ name: filename, data: base64, contentType: 'image/jpeg' }]
        };

        const res = await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
        showStatus("✅ Sent. Check your inbox!", "success");
        form.reset(); dateEl.valueAsDate = new Date();
        preview.innerHTML = '<span class="hint">Preview appears here after you choose a photo.</span>';
        currentCanvas = null; currentBlob = null; originalFile = null;
        syncSendTo(); // reset disabled state
      }catch(err){
        console.error(err);
        showStatus(`Couldn’t send. ${err?.text || err?.message || 'Check EmailJS logs for details.'}`, "error");
      }finally{
        sendBtn.disabled = false;
      }
    }

    form.addEventListener('submit', handleSubmit);
  </script>
</body>
</html>


