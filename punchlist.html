<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
<title>Comet — Initial Punchlist</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --white:#fff; --bg:#f8fafc; --ink:#0b1220;
    --blue:#2563eb; --blue2:#3b82f6; --muted:#6b7280;
    --card:#ffffff; --border:#e5e7eb; --shadow:rgba(0,0,0,.07);
    --yellow:#fff7ae;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:'Inter',system-ui,Segoe UI,Roboto,Arial,sans-serif;}
  .wrap{max-width:1100px;margin:0 auto;padding:24px}
  header{display:flex;align-items:center;justify-content:space-between;padding:8px 0 18px;border-bottom:1px solid var(--border)}
  .brand{display:flex;gap:12px;align-items:center}
  .brand svg{width:30px;height:30px}
  .brand h1{margin:0;font-size:1.35rem;letter-spacing:.2px}
  .sub{color:var(--muted);font-weight:600}

  .bar{display:flex;gap:10px;flex-wrap:wrap;margin:16px 0 20px}
  .btn{appearance:none;border:1px solid transparent;background:var(--blue);color:#fff;padding:10px 14px;
       border-radius:10px;font-weight:700;text-decoration:none;cursor:pointer}
  .btn:hover{background:var(--blue2)}
  .ghost{background:transparent;border-color:var(--blue);color:var(--blue)}
  .danger{background:#ef4444;border-color:#ef4444}
  .ghost:hover{background:rgba(37,99,235,.08)}
  .grid{display:grid;gap:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 8px 22px var(--shadow)}
  label{font-weight:600;font-size:.95rem;color:#111827}
  input, textarea, select{width:100%;padding:12px 12px;font-size:16px;border:1px solid var(--border);border-radius:10px;background:#fff}
  textarea{min-height:90px;resize:vertical}

  .two{display:grid;gap:14px}
  @media(min-width:800px){.two{grid-template-columns:1fr 1fr}}
  .three{display:grid;gap:14px}
  @media(min-width:900px){.three{grid-template-columns:1.2fr 1fr 1fr}}

  table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:14px;border:1px solid var(--border);background:#fff}
  thead th{position:sticky;top:0;background:#f1f5f9;border-bottom:1px solid var(--border);padding:10px 8px;text-align:left;font-size:.9rem}
  tbody td{border-top:1px solid var(--border);padding:0}
  tbody tr:first-child td{border-top:none}
  .rownum{width:70px;text-align:center;color:#475569;font-weight:700;background:#f8fafc;border-right:1px solid var(--border);cursor:pointer}
  .rownum small{display:block;font-weight:600;color:#64748b}
  .cell input,.cell textarea{border:none;border-radius:0;width:100%;padding:12px 10px;font-size:16px}
  .cell textarea{min-height:48px}
  .hl{background:var(--yellow)}
  .tbar{display:flex;gap:10px;justify-content:flex-end;margin:10px 0}

  footer{margin-top:20px;color:var(--muted);text-align:center}

  /* Hide export controls during capture */
  body.exporting .no-export{display:none !important}

  /* Print Styles */
  @media print{
    header .bar, .tbar, .no-print{display:none !important}
    body{background:#fff}
    .wrap{padding:0}
    .card{box-shadow:none;border:1px solid #ddd;page-break-inside:avoid}
    thead th{background:#eaf0ff !important}
    a[href]:after{content:""}
  }
</style>
</head>
<body>
<div class="wrap" id="content">
  <header>
    <div class="brand">
      <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 2l2.6 5.3L20 8l-4 3.9.9 5.6L12 15.8 7.1 17.5 8 11.9 4 8l5.4-.7L12 2z" fill="#2563eb"/></svg>
      <div>
        <h1>Comet Builders LLC</h1>
        <div class="sub">Initial Punchlist</div>
      </div>
    </div>
    <div class="bar no-export">
      <button class="btn" onclick="doPrint()">Print</button>
      <button class="btn ghost" onclick="downloadPDF()">Download PDF</button>
      <button class="btn ghost" onclick="saveState()">Save</button>
      <button class="btn ghost" onclick="loadState()">Load</button>
      <button class="btn danger" onclick="clearAll()">Clear</button>
    </div>
  </header>

  <section class="grid">
    <div class="card">
      <div class="three">
        <div>
          <label>Project Name</label>
          <input id="proj" placeholder="e.g., Comet Westgate">
        </div>
        <div>
          <label>Site Contact</label>
          <input id="contact" placeholder="Name + phone">
        </div>
        <div>
          <label>Date</label>
          <input id="date" type="date">
        </div>
      </div>
      <div class="two" style="margin-top:14px">
        <div>
          <label>Building / Phase</label>
          <input id="building" placeholder="e.g., B01 or Phase 1">
        </div>
        <div>
          <label>General Notes</label>
          <input id="gn" placeholder="Optional header notes">
        </div>
      </div>
    </div>

    <div class="card">
      <div class="tbar no-print no-export">
        <button class="btn" onclick="addRow()">Add Row</button>
        <button class="btn ghost" onclick="addTen()">Add 10 Rows</button>
      </div>
      <table id="plist">
        <thead>
          <tr>
            <th style="width:80px"># / Highlight</th>
            <th style="width:160px">Unit / Address</th>
            <th>Item Description</th>
            <th style="width:28%">Notes</th>
          </tr>
        </thead>
        <tbody id="body"></tbody>
      </table>
    </div>
  </section>

  <footer>© <span id="yy"></span> Comet Builders LLC</footer>
</div>

<!-- PDF libs -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
  const KEY = 'punchlist_initial_v1';
  document.getElementById('yy').textContent = new Date().getFullYear();
  document.getElementById('date').valueAsDate = new Date();

  function rowTemplate(i, data={}){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="rownum" onclick="toggleHL(this)">${i}<small>tap to highlight</small></td>
      <td class="cell"><input value="${(data.unit||'')}"></td>
      <td class="cell"><textarea>${(data.item||'')}</textarea></td>
      <td class="cell"><textarea>${(data.notes||'')}</textarea></td>
    `;
    if(data.hl) tr.classList.add('hl');
    return tr;
  }

  function addRow(prefill={}){
    const body = document.getElementById('body');
    const idx = body.children.length + 1;
    body.appendChild(rowTemplate(idx, prefill));
  }
  function addTen(){ for(let i=0;i<10;i++) addRow(); }

  function toggleHL(cell){ cell.parentElement.classList.toggle('hl'); }

  function collect(){
    const rows = [...document.querySelectorAll('#body tr')].map(tr=>{
      const [_, unit, item, notes] = tr.querySelectorAll('td');
      return {
        hl: tr.classList.contains('hl'),
        unit: unit.querySelector('input').value,
        item: item.querySelector('textarea').value,
        notes: notes.querySelector('textarea').value
      };
    });
    return {
      meta:{
        proj:val('proj'), contact:val('contact'), date:val('date'),
        building:val('building'), gn:val('gn')
      },
      rows
    };
  }
  const val=id=>document.getElementById(id).value;

  function applyState(obj){
    if(!obj) return;
    const {meta, rows} = obj;
    document.getElementById('proj').value = meta?.proj || '';
    document.getElementById('contact').value = meta?.contact || '';
    document.getElementById('date').value = meta?.date || new Date().toISOString().slice(0,10);
    document.getElementById('building').value = meta?.building || '';
    document.getElementById('gn').value = meta?.gn || '';
    const body = document.getElementById('body');
    body.innerHTML = '';
    (rows||[]).forEach((r,i)=>body.appendChild(rowTemplate(i+1, r)));
    if((rows||[]).length===0) addTen();
  }

  function saveState(){ localStorage.setItem(KEY, JSON.stringify(collect())); alert('Saved!'); }
  function loadState(){
    const raw = localStorage.getItem(KEY);
    if(!raw){ alert('Nothing saved yet.'); return; }
    applyState(JSON.parse(raw));
  }
  function clearAll(){
    if(!confirm('Clear the whole sheet?')) return;
    localStorage.removeItem(KEY);
    applyState({rows:[]});
  }
  function doPrint(){ window.print(); }

  // Auto-save every second
  setInterval(()=>localStorage.setItem(KEY, JSON.stringify(collect())), 1000);

  // Initialize
  applyState(JSON.parse(localStorage.getItem(KEY) || '{"rows": []}'));

  /* ---------- PDF EXPORT ---------- */
  async function downloadPDF(){
    await saveBeforeExport();
    await exportElementToPDF(document.getElementById('content'),
      makeFilename('Initial-Punchlist'));
  }

  async function saveBeforeExport(){
    // Hide export-only controls during capture
    document.body.classList.add('exporting');
    await new Promise(r=>setTimeout(r, 50));
  }

  async function exportElementToPDF(el, filename){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({orientation:'p', unit:'pt', format:'letter'});
    const canvas = await html2canvas(el, {scale:2, useCORS:true, windowWidth: el.scrollWidth});
    const imgData = canvas.toDataURL('image/png');

    const pdfW = doc.internal.pageSize.getWidth();
    const pdfH = doc.internal.pageSize.getHeight();
    const imgW = pdfW;
    const imgH = canvas.height * (imgW / canvas.width);

    let heightLeft = imgH;
    let position = 0;

    doc.addImage(imgData, 'PNG', 0, position, imgW, imgH);
    heightLeft -= pdfH;

    while (heightLeft > 0) {
      position = -(imgH - heightLeft);
      doc.addPage();
      doc.addImage(imgData, 'PNG', 0, position, imgW, imgH);
      heightLeft -= pdfH;
    }

    doc.save(filename + '.pdf');
    document.body.classList.remove('exporting');
  }

  function makeFilename(prefix){
    const date = (document.getElementById('date').value || new Date().toISOString().slice(0,10));
    const proj = (document.getElementById('proj').value || 'Project').replace(/[^\w-]+/g,'_');
    const bldg = (document.getElementById('building').value || 'Bldg').replace(/[^\w-]+/g,'_');
    return `${prefix}—${proj}—${bldg}—${date}`;
  }
</script>
</body>
</html>
