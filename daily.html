<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Reports</title>
  <meta name="description" content="Lightweight daily construction report web app. Works on GitHub Pages. Saves to localStorage. Export to JSON or Print to PDF." />
  <style>
    :root{
      --ink:#0e1223; --bg:#0b0f1a; --card:#121826; --muted:#8ea0b5; --brand:#4f8cff; --accent:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:#e9eef6}
    a{color:var(--brand)}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}

    /* Header: sticky on desktop, not sticky on mobile */
    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,rgba(11,15,26,.95),rgba(11,15,26,.75));backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid #1f2a44}
    @media (max-width:900px){ header{ position:static; } }

    .top{display:flex;align-items:center;gap:14px;max-width:1100px;margin:0 auto;padding:14px 24px}
    .logo{width:42px;height:42px;border-radius:12px;background:#0a1222;border:1px solid #203152;display:grid;place-items:center;font-weight:800}
    h1{font-size:18px;margin:0}
    .actions{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
    button,.btn{border:1px solid #29406b;background:#16223a;color:#e9eef6;padding:10px 14px;border-radius:10px;cursor:pointer;text-decoration:none;display:inline-block}
    button:hover,.btn:hover{background:#1a2a49}
    .btn.primary{background:linear-gradient(180deg,#335ba8,#23437e);border-color:#2a4581}
    .btn.success{background:linear-gradient(180deg,#2e7d32,#1e5c22);border-color:#2e7d32}
    .btn.warn{background:linear-gradient(180deg,#b45309,#8a3f07);border-color:#b45309}
    .btn.ghost{background:transparent;border-color:#2a3b5e}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(12,1fr)}
    .card{grid-column:span 12;background:var(--card);border:1px solid #1f2a44;border-radius:16px;padding:16px}
    .card h2{font-size:16px;margin:0 0 12px 0;color:#cfe1ff}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;margin-bottom:10px}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a3b5e;background:#0e1527;color:#e9eef6}
    textarea{min-height:110px;resize:vertical}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #263452;padding:8px;text-align:left;vertical-align:top}
    th{background:#0f1730;color:#b9cbe7}
    .tools{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 0}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px dashed #2a3b5e;border-radius:999px;color:#b9cbe7;font-size:12px}
    .muted{color:var(--muted);font-size:12px}
    .danger{color:var(--danger)}
    .gallery{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
    .gallery img{width:100%;height:90px;object-fit:cover;border-radius:10px;border:1px solid #263452}
    .kpi{display:flex;gap:16px;flex-wrap:wrap}
    .kpi .box{flex:1 1 160px;background:#0f1730;border:1px solid #263452;border-radius:12px;padding:12px}
    .box b{font-size:20px}

    /* Auto-growing Notes cells */
    td textarea.grow{min-height:42px;line-height:1.3;resize:vertical;overflow:hidden}

    /* Responsive */
    @media (max-width:900px){
      .row{grid-template-columns:repeat(6,1fr)}
      .gallery{grid-template-columns:repeat(3,1fr)}
    }
    @media (max-width:600px){
      .row{grid-template-columns:repeat(2,1fr)}
      .gallery{grid-template-columns:repeat(2,1fr)}
    }

    /* Print */
    @media print{
      header,.actions,.tools,.pill,.btn{display:none !important}
      body{background:#fff !important;color:#000 !important}
      .card{break-inside:avoid;background:#fff !important;border:1px solid #000 !important}
      input,select,textarea{background:#fff !important;color:#000 !important;-webkit-text-fill-color:#000 !important;border:1px solid #000 !important}
      th,td{border-color:#000 !important;color:#000 !important}
      th{background:#fff !important;color:#000 !important}
      .kpi .box{ background:#fff !important; color:#000 !important; border:2px solid #000 !important; }
      .kpi .box label, .kpi .box b{ color:#000 !important; }
    }
  </style>
</head>
<body>

  <!-- Anti-stale updater (plain ES5; bump version when you deploy) -->
  <script>
    (function(){
      var APP_VERSION = '2025-10-07-04'; // CHANGE when you deploy
      try {
        var stored = localStorage.getItem('app_version');
        if (stored !== APP_VERSION) {
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(regs){
              regs.forEach(function(r){ r.unregister(); });
              if (window.caches && caches.keys) {
                caches.keys().then(function(keys){
                  keys.forEach(function(k){ caches.delete(k); });
                  localStorage.setItem('app_version', APP_VERSION);
                  location.reload();
                });
              } else {
                localStorage.setItem('app_version', APP_VERSION);
                location.reload();
              }
            });
          } else {
            localStorage.setItem('app_version', APP_VERSION);
          }
        }
      } catch (e) {
        // fail open
      }
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.addEventListener('controllerchange', function(){ location.reload(); });
      }
    })();
  </script>

  <header>
    <div class="top">
      <div class="logo">DR</div>
      <h1>Daily Reports</h1>
      <div class="actions">
        <!-- NEW: Home button back to landing page -->
        <a class="btn ghost" href="index.html">Home</a>

        <button class="btn primary" id="saveBtn">Save Draft</button>
        <button class="btn" id="newBtn">New</button>
        <button class="btn" id="exportBtn">Export JSON</button>
        <label class="btn ghost" for="importFile">Import JSON</label>
        <input type="file" id="importFile" accept="application/json" hidden>
        <button class="btn success" id="printBtn">Print / PDF</button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <section class="grid">
      <!-- Report Meta -->
      <div class="card">
        <h2>Report Info</h2>
        <div class="row">
          <div style="grid-column:span 3">
            <label for="date">Date</label>
            <input type="date" id="date">
          </div>
          <div style="grid-column:span 5">
            <label for="project">Project</label>
            <select id="project">
              <option value="">Select project…</option>
              <option>Comet Sneads Ferry Apartments</option>
              <option>Comet Pittsboro</option>
              <option>Comet Raleigh</option>
              <option>Comet Greensboro</option>
              <option>Custom…</option>
            </select>
          </div>
          <div style="grid-column:span 4">
            <label for="customProject">Custom Project (if needed)</label>
            <input id="customProject" placeholder="Enter custom project name" />
          </div>
        </div>
        <div class="row">
          <div style="grid-column:span 3">
            <label for="weather">Weather (summary)</label>
            <input id="weather" placeholder="e.g., 78°F, partly cloudy, 5 mph SW" />
          </div>
          <div style="grid-column:span 3">
            <label for="tempRange">Temp Range</label>
            <input id="tempRange" placeholder="e.g., 70–84°F" />
          </div>
          <div style="grid-column:span 3">
            <label for="precip">Precipitation</label>
            <input id="precip" placeholder="e.g., 0.1 in" />
          </div>
          <div style="grid-column:span 3">
            <label for="wind">Wind</label>
            <input id="wind" placeholder="e.g., 8 mph SW" />
          </div>
        </div>
        <div class="kpi">
          <div class="box"><label>Total Crew</label><div><b id="kpiCrew">0</b></div></div>
          <div class="box"><label>Vendors On-Site</label><div><b id="kpiVendors">0</b></div></div>
          <div class="box"><label>Open Issues</label><div><b id="kpiIssues">0</b></div></div>
          <div class="box"><label>Inspections</label><div><b id="kpiInsp">0</b></div></div>
        </div>
      </div>

      <!-- Manpower & Vendors -->
      <div class="card">
        <h2>Manpower & Vendors</h2>
        <div class="tools">
          <button class="btn" id="addLabor">+ Add Row</button>
          <button class="btn ghost" id="clearLabor">Clear</button>
        </div>
        <div style="overflow:auto;margin-top:8px">
          <table id="laborTable">
            <thead>
              <tr>
                <th>Company / Trade</th>
                <th>Building</th>
                <th>Supervisor</th>
                <th># Crew</th>
                <th>Time On</th>
                <th>Time Off</th>
                <th>Notes</th>
                <th>—</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Work Performed -->
      <div class="card">
        <h2>Work Performed</h2>
        <div class="row">
          <div style="grid-column:span 12">
            <label for="workPerformed">Summary (by area/trade)</label>
            <textarea id="workPerformed" placeholder="Example: Bldg 1 – framing 2nd floor; Bldg 2 – MEP rough-ins; Site – irrigation mainline S of Bldg 3; etc."></textarea>
          </div>
        </div>
      </div>

      <!-- Deliveries -->
      <div class="card">
        <h2>Deliveries</h2>
        <div class="tools">
          <button class="btn" id="addDelivery">+ Add Delivery</button>
          <button class="btn ghost" id="clearDelivery">Clear</button>
        </div>
        <div style="overflow:auto;margin-top:8px">
          <table id="deliveryTable">
            <thead>
              <tr>
                <th>Time</th>
                <th>Vendor</th>
                <th>Material / Qty</th>
                <th>For Area</th>
                <th>Notes</th>
                <th>Received By</th>
                <th>—</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Inspections & Tests -->
      <div class="card">
        <h2>Inspections & Tests</h2>
        <div class="tools">
          <button class="btn" id="addInsp">+ Add Item</button>
          <button class="btn ghost" id="clearInsp">Clear</button>
        </div>
        <div style="overflow:auto;margin-top:8px">
          <table id="inspTable">
            <thead>
              <tr>
                <th>Agency / Inspector</th>
                <th>Type</th>
                <th>Building/Area</th>
                <th>Status</th>
                <th>Notes</th>
                <th>—</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Safety / Incidents -->
      <div class="card">
        <h2>Safety</h2>
        <div class="row">
          <div style="grid-column:span 6">
            <label for="safetyObservations">Observations / Toolbox Talks</label>
            <textarea id="safetyObservations" placeholder="PPE compliance, tailgate topics, near-miss notes, etc."></textarea>
          </div>
          <div style="grid-column:span 6">
            <label for="incidents">Incidents</label>
            <textarea id="incidents" placeholder="Describe any incidents. If none, write N/A."></textarea>
          </div>
        </div>
      </div>

      <!-- Delays / Constraints -->
      <div class="card">
        <h2>Delays & Constraints</h2>
        <div class="row">
          <div style="grid-column:span 12">
            <label for="delays">Delays / Constraints / RFI Needs</label>
            <textarea id="delays" placeholder="Inspections pending, utility conflicts, weather holds, approvals needed, etc."></textarea>
          </div>
        </div>
      </div>

      <!-- Equipment On Site -->
      <div class="card">
        <h2>Equipment On-Site</h2>
        <div class="tools">
          <button class="btn" id="addEquip">+ Add Equipment</button>
          <button class="btn ghost" id="clearEquip">Clear</button>
        </div>
        <div style="overflow:auto;margin-top:8px">
          <table id="equipTable">
            <thead>
              <tr>
                <th>Type</th>
                <th>Owner</th>
                <th>Qty</th>
                <th>Location</th>
                <th>Notes</th>
                <th>—</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Photos -->
      <div class="card">
        <h2>Photos</h2>
        <div class="tools">
          <label class="btn" for="photoInput">+ Add Photos</label>
          <input type="file" id="photoInput" accept="image/*" multiple hidden>
          <button class="btn ghost" id="clearPhotos">Clear</button>
          <span class="muted">(Images save in your browser; large sets may slow down.)</span>
        </div>
        <div class="gallery" id="gallery"></div>
      </div>

      <!-- Sign-off -->
      <div class="card">
        <h2>Sign-Off</h2>
        <div class="row">
          <div style="grid-column:span 4">
            <label for="preparedBy">Prepared By</label>
            <input id="preparedBy" placeholder="Your name" />
          </div>
          <div style="grid-column:span 4">
            <label for="title">Title</label>
            <input id="title" placeholder="e.g., Superintendent" />
          </div>
          <div style="grid-column:span 4">
            <label for="preparedAt">Prepared At (time)</label>
            <input id="preparedAt" type="time" />
          </div>
        </div>
      </div>

      <!-- History -->
      <div class="card">
        <h2>Saved Reports (this browser)</h2>
        <div class="tools">
          <button class="btn warn" id="wipeAll">Delete All Drafts</button>
          <span class="muted">(Use Export JSON first if you want a backup!)</span>
        </div>
        <div id="history"></div>
      </div>
    </section>
  </div>

  <!-- Error toast -->
  <script>
    window.addEventListener('error', function(e){
      var msg = (e && e.message) ? e.message : 'Unknown script error';
      var t = document.createElement('div');
      t.textContent = 'Script error: ' + msg;
      t.style.position='fixed';t.style.left='16px';t.style.bottom='16px';
      t.style.padding='8px 12px';t.style.background='#b91c1c';t.style.color='#fff';
      t.style.borderRadius='8px';t.style.zIndex=9999;
      document.body.appendChild(t); setTimeout(function(){t.remove();}, 4000);
    });
  </script>

  <!-- Main JS (ES5-friendly) -->
  <script>
  function $(s, r){ return (r||document).querySelector(s); }
  function $$(s, r){ return Array.prototype.slice.call((r||document).querySelectorAll(s)); }
  var STORAGE_KEY = 'dailyReportDrafts_v1';
  var currentId = null;

  function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }
  function getDrafts(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }catch(e){ return []; } }
  function setDrafts(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]; }); }

  function inputForCell(idx, val, tableSel){
    var numberCol = (tableSel==='#laborTable' && idx===3) || (tableSel==='#equipTable' && idx===2);
    var notesCol =
      (tableSel==='#laborTable' && idx===6) ||
      (tableSel==='#deliveryTable' && idx===4) ||
      (tableSel==='#inspTable' && idx===4) ||
      (tableSel==='#equipTable' && idx===4);
    if (notesCol) {
      var v = val ? escapeHtml(val) : '';
      return '<textarea class="grow">'+v+'</textarea>';
    }
    return '<input '+(numberCol? 'type="number" min="0"':'' )+' value="'+(val?escapeHtml(val):'')+'" />';
  }

  function addRow(tbody, cells){
    if(!tbody) return;
    var tr = document.createElement('tr');
    tr.innerHTML = cells.map(function(c){ return '<td>'+c+'</td>'; }).join('') + '<td><button class="btn ghost" data-remove>✕</button></td>';
    tbody.appendChild(tr);
    $$('.grow', tr).forEach(autoGrow);
    updateKPIs();
  }

  function tableToJSON(sel){
    var rows = $$(sel+' tbody tr');
    return rows.map(function(tr){
      return Array.prototype.slice.call(tr.querySelectorAll('td')).slice(0,-1).map(function(td){
        var input = td.querySelector('input,textarea,select');
        return input ? input.value : td.textContent;
      });
    });
  }
  function jsonToTable(sel, rows){
    var tbody = $(sel+' tbody'); if(!tbody) return;
    tbody.innerHTML='';
    rows.forEach(function(r, i){
      addRow(tbody, r.map(function(v, idx){ return inputForCell(idx, v, sel); }));
    });
  }

  function getForm(){
    var labor = tableToJSON('#laborTable');
    var deliveries = tableToJSON('#deliveryTable');
    var inspections = tableToJSON('#inspTable');
    var equipment = tableToJSON('#equipTable');
    var photos = $$('#gallery img').map(function(img){ return img.src; });
    return {
      id: currentId || uid(),
      date: $('#date') ? $('#date').value : '',
      project: $('#project') ? $('#project').value : '',
      customProject: $('#customProject') ? $('#customProject').value : '',
      weather: $('#weather') ? $('#weather').value : '',
      tempRange: $('#tempRange') ? $('#tempRange').value : '',
      precip: $('#precip') ? $('#precip').value : '',
      wind: $('#wind') ? $('#wind').value : '',
      workPerformed: $('#workPerformed') ? $('#workPerformed').value : '',
      safetyObservations: $('#safetyObservations') ? $('#safetyObservations').value : '',
      incidents: $('#incidents') ? $('#incidents').value : '',
      delays: $('#delays') ? $('#delays').value : '',
      preparedBy: $('#preparedBy') ? $('#preparedBy').value : '',
      title: $('#title') ? $('#title').value : '',
      preparedAt: $('#preparedAt') ? $('#preparedAt').value : '',
      labor: labor, deliveries: deliveries, inspections: inspections, equipment: equipment, photos: photos,
      savedAt: new Date().toISOString()
    };
  }

  function setForm(data){
    var map = [
      ['#date','date'],['#project','project'],['#customProject','customProject'],
      ['#weather','weather'],['#tempRange','tempRange'],['#precip','precip'],['#wind','wind'],
      ['#workPerformed','workPerformed'],['#safetyObservations','safetyObservations'],
      ['#incidents','incidents'],['#delays','delays'],['#preparedBy','preparedBy'],
      ['#title','title'],['#preparedAt','preparedAt']
    ];
    map.forEach(function(pair){
      var sel = pair[0], key = pair[1];
      if($(sel)) $(sel).value = data[key] || '';
    });
    jsonToTable('#laborTable', data.labor||[]);
    jsonToTable('#deliveryTable', data.deliveries||[]);
    jsonToTable('#inspTable', data.inspections||[]);
    jsonToTable('#equipTable', data.equipment||[]);
    if($('#gallery')) $('#gallery').innerHTML = '';
    (data.photos||[]).forEach(function(src){ addPhotoToGallery(src); });
    updateKPIs();
  }

  function addPhotoToGallery(src){
    var img = document.createElement('img');
    img.src = src; if($('#gallery')) $('#gallery').appendChild(img);
  }

  function updateKPIs(){
    var labor = tableToJSON('#laborTable');
    var totalCrew = labor.reduce(function(sum,row){ return sum + (parseInt(row[3]||0,10)||0); }, 0);
    if($('#kpiCrew')) $('#kpiCrew').textContent = totalCrew;
    if($('#kpiVendors')) $('#kpiVendors').textContent = (function(){
      var set = {}; labor.forEach(function(r){ if(r[0]) set[r[0]] = 1; }); return Object.keys(set).length || 0;
    })();
    if($('#kpiIssues')) $('#kpiIssues').textContent = ($('#delays') && $('#delays').value.trim() ? 1 : 0) + ($('#incidents') && $('#incidents').value.trim()?1:0);
    if($('#kpiInsp')) $('#kpiInsp').textContent = tableToJSON('#inspTable').length;
  }

  function autoGrow(el){ if (!el) return; el.style.height='auto'; el.style.height=(el.scrollHeight+2)+'px'; }

  /* helpers restored in case they're used from buttons */
  function loadDraft(id){
    var drafts = getDrafts();
    var d = drafts.find(function(x){ return x.id===id; });
    if(!d) return;
    currentId = id;
    setForm(d);
  }
  function deleteDraft(id){
    var remain = getDrafts().filter(function(x){ return x.id!==id; });
    setDrafts(remain);
    if(currentId===id){ currentId=null; }
    if (window.renderHistory) window.renderHistory();
  }

  document.addEventListener('input', function(e){
    var el = e.target;
    if (el && el.classList && el.classList.contains('grow')) autoGrow(el);
    if (el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.tagName === 'SELECT')) updateKPIs();
  });

  document.addEventListener('DOMContentLoaded', function(){
    function seed(){
      addRow($('#laborTable tbody'), [
        inputForCell(0,'' ,'#laborTable'),
        inputForCell(1,'' ,'#laborTable'),
        inputForCell(2,'' ,'#laborTable'),
        inputForCell(3,'' ,'#laborTable'),
        inputForCell(4,'' ,'#laborTable'),
        inputForCell(5,'' ,'#laborTable'),
        inputForCell(6,'' ,'#laborTable')
      ]);
      addRow($('#deliveryTable tbody'), [
        inputForCell(0,'' ,'#deliveryTable'),
        inputForCell(1,'' ,'#deliveryTable'),
        inputForCell(2,'' ,'#deliveryTable'),
        inputForCell(3,'' ,'#deliveryTable'),
        inputForCell(4,'' ,'#deliveryTable'),
        inputForCell(5,'' ,'#deliveryTable')
      ]);
      addRow($('#inspTable tbody'), [
        inputForCell(0,'' ,'#inspTable'),
        inputForCell(1,'' ,'#inspTable'),
        inputForCell(2,'' ,'#inspTable'),
        inputForCell(3,'' ,'#inspTable'),
        inputForCell(4,'' ,'#inspTable')
      ]);
      addRow($('#equipTable tbody'), [
        inputForCell(0,'' ,'#equipTable'),
        inputForCell(1,'' ,'#equipTable'),
        inputForCell(2,'' ,'#equipTable'),
        inputForCell(3,'' ,'#equipTable'),
        inputForCell(4,'' ,'#equipTable')
      ]);
    }

    document.addEventListener('click', function(e){
      var btn = e.target.closest ? e.target.closest('button') : null; if (!btn) return;

      if (btn.hasAttribute('data-remove')) { var row = btn.closest && btn.closest('tr'); if(row) row.parentNode.removeChild(row); updateKPIs(); return; }

      switch (btn.id) {
        case 'saveBtn':
          var draft = getForm();
          var ds = getDrafts();
          var i = ds.findIndex(function(d){ return d.id === draft.id; });
          if(i>=0) ds[i] = draft; else ds.push(draft);
          setDrafts(ds); currentId = draft.id; if(window.renderHistory) window.renderHistory();
          break;

        case 'newBtn':
          if (confirm('Clear the form for a new report?')) { currentId = null; setForm({}); seed(); }
          break;

        case 'exportBtn':
          var data = getForm();
          var blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
          var a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'daily-report_'+(data.date||'undated')+'.json';
          a.click();
          break;

        case 'printBtn':
          setTimeout(function(){ window.print(); }, 0);
          break;

        case 'addLabor':
          addRow($('#laborTable tbody'), [
            inputForCell(0,'' ,'#laborTable'),
            inputForCell(1,'' ,'#laborTable'),
            inputForCell(2,'' ,'#laborTable'),
            inputForCell(3,'' ,'#laborTable'),
            inputForCell(4,'' ,'#laborTable'),
            inputForCell(5,'' ,'#laborTable'),
            inputForCell(6,'' ,'#laborTable')
          ]);
          break;

        case 'clearLabor':
          if(confirm('Clear labor table?')) { $('#laborTable tbody').innerHTML=''; updateKPIs(); }
          break;

        case 'addDelivery':
          addRow($('#deliveryTable tbody'), [
            inputForCell(0,'' ,'#deliveryTable'),
            inputForCell(1,'' ,'#deliveryTable'),
            inputForCell(2,'' ,'#deliveryTable'),
            inputForCell(3,'' ,'#deliveryTable'),
            inputForCell(4,'' ,'#deliveryTable'),
            inputForCell(5,'' ,'#deliveryTable')
          ]);
          break;

        case 'clearDelivery':
          if(confirm('Clear deliveries?')) { $('#deliveryTable tbody').innerHTML=''; updateKPIs(); }
          break;

        case 'addInsp':
          addRow($('#inspTable tbody'), [
            inputForCell(0,'' ,'#inspTable'),
            inputForCell(1,'' ,'#inspTable'),
            inputForCell(2,'' ,'#inspTable'),
            inputForCell(3,'' ,'#inspTable'),
            inputForCell(4,'' ,'#inspTable')
          ]);
          break;

        case 'clearInsp':
          if(confirm('Clear inspections?')) { $('#inspTable tbody').innerHTML=''; updateKPIs(); }
          break;

        case 'addEquip':
          addRow($('#equipTable tbody'), [
            inputForCell(0,'' ,'#equipTable'),
            inputForCell(1,'' ,'#equipTable'),
            inputForCell(2,'' ,'#equipTable'),
            inputForCell(3,'' ,'#equipTable'),
            inputForCell(4,'' ,'#equipTable')
          ]);
          break;

        case 'clearEquip':
          if(confirm('Clear equipment?')) { $('#equipTable tbody').innerHTML=''; updateKPIs(); }
          break;

        default:
          if (btn.dataset && btn.dataset.load) loadDraft(btn.dataset.load);
          if (btn.dataset && btn.dataset.del)  { if (confirm('Delete this draft?')) deleteDraft(btn.dataset.del); }
      }
    });

    function renderHistory(){
      var drafts = getDrafts().sort(function(a,b){ return (b.date||'').localeCompare(a.date||''); });
      var el = $('#history'); if(!el){ return; }
      if(!drafts.length){ el.innerHTML = '<p class="muted">No drafts saved yet.</p>'; return; }
      el.innerHTML = drafts.map(function(d){
        var title = (d.date||'—')+' · '+(d.customProject||d.project||'—');
        return '<div style="display:flex;gap:10px;align-items:center;margin:8px 0;padding:10px;border:1px solid #2a3b5e;border-radius:10px">'+
          '<div style="flex:1 1 auto">'+title+'</div>'+
          '<button class="btn" data-load="'+d.id+'">Open</button>'+
          '<button class="btn ghost danger" data-del="'+d.id+'">Delete</button>'+
        '</div>';
      }).join('');
    }
    window.renderHistory = renderHistory;

    var today = new Date();
    if($('#date')) $('#date').valueAsDate = today;
    if($('#preparedAt')) $('#preparedAt').value = today.toTimeString().slice(0,5);
    seed();
    renderHistory();
    updateKPIs();
  });

  // photos
  var photoInput = $('#photoInput');
  if(photoInput){
    photoInput.addEventListener('change', function(e){
      var files = Array.prototype.slice.call(e.target.files||[]);
      files.forEach(function(f){
        var r = new FileReader();
        r.onload = function(){ var img = document.createElement('img'); img.src = r.result; if($('#gallery')) $('#gallery').appendChild(img); };
        r.readAsDataURL(f);
      });
    });
  }
  var clearPhotosBtn = $('#clearPhotos');
  if(clearPhotosBtn){
    clearPhotosBtn.addEventListener('click', function(){ if(confirm('Clear photos?')) $('#gallery').innerHTML=''; });
  }
  var wipeAllBtn = $('#wipeAll');
  if(wipeAllBtn){
    wipeAllBtn.addEventListener('click', function(){ if(confirm('Delete ALL drafts saved in this browser?')) { localStorage.removeItem(STORAGE_KEY); var h = document.querySelector('#history'); if(h) h.innerHTML=''; }});
  }
  </script>
</body>
</html>















